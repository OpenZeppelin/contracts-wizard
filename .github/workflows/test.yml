name: Test

on:
  push:
    branches: [master, stellar-scafold-fargate-backend, stellar-scafold]
  pull_request: {}

jobs:
  format-lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      - name: Set up environment
        uses: ./.github/actions/setup
      - name: Check formatting
        run: yarn format:check
      - name: Run linter
        run: yarn lint

  deno-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      - name: Set up Deno 1.46.3 (matching Netlify edge function environment)
        uses: denoland/setup-deno@e95548e56dfa95d4e1a28d6f422fafe75c4c26fb # v2.0.3
        with:
          deno-version: "1.46.3"
      - name: Set up environment
        uses: ./.github/actions/setup
      - name: Deno check API
        run: yarn type:check:api

  mcp:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      - name: Set up environment
        uses: ./.github/actions/setup
      - name: Run tests
        run: yarn test
        working-directory: packages/mcp

  ui:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      - name: Set up environment
        uses: ./.github/actions/setup
      - name: Run tests
        run: yarn test
        working-directory: packages/ui

  stellar-backend:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: packages/ui/api/stellar
    steps:
      # Checkout the repository
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@f4a75cfd619ee5ce8d5b864b0d183aff3c69b55a # v2.13.1
        with:
          egress-policy: audit
      - name: Checkout Code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      - name: free disk space
        run: |
          sudo swapoff -a
          sudo rm -f /swapfile
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo apt clean
          if [[ $(docker image ls -aq) ]]; then
            docker rmi $(docker image ls -aq)
          else
            echo "No Docker images found to remove"
          fi
      - name: Prepare
        id: init
        uses: ./.github/actions/prepare
        with:
          components: llvm-tools-preview

      # Get the output of the prepare composite action
      - name: Get cache-hit output
        run: 'echo "Cache hit >>>>>: ${{ steps.init.outputs.cache-hit }}"'
      - name: Install cargo hack and cargo-llvm-cov
        uses: taiki-e/install-action@a24ba45235ed716ff76646268742990dc9458860 # v2.62.42
        with:
          tool: cargo-hack,cargo-llvm-cov
      - name: Build
        run: cargo test --no-run --locked

      - name: Run Developer Tests (excluding AI) and Generate Coverage Report
        id: dev_coverage
        env:
          LLVM_PROFILE_FILE: stellar-backend-dev-%p-%m.profraw
          RUSTFLAGS: -Cinstrument-coverage
          RUST_TEST_THREADS: 1
        run: |
          cargo hack llvm-cov --locked --lib --lcov --output-path stellar-backend-dev-lcov.info --tests -- --skip ai_

      - name: Upload Developer Coverage to Codecov
        uses: codecov/codecov-action@5a1091511ad55cbe89839c7260b706298ca349f7 # v5.5.1
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          name: stellar-backend-dev-coverage
          files: packages/ui/api/stellar/stellar-backend-dev-lcov.info
          flags: stellar-backend-dev
          fail_ci_if_error: true

      - name: Run AI Tests and Generate Coverage Report
        id: ai_coverage
        env:
          LLVM_PROFILE_FILE: stellar-backend-ai-%p-%m.profraw
          RUSTFLAGS: -Cinstrument-coverage
          RUST_TEST_THREADS: 1
        run: |
          cargo hack llvm-cov --locked --lib --lcov --output-path stellar-backend-ai-lcov.info --tests -- ai_

      - name: Upload AI Coverage to Codecov
        uses: codecov/codecov-action@5a1091511ad55cbe89839c7260b706298ca349f7 # v5.5.1
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          name: stellar-backend-ai-coverage
          files: packages/ui/api/stellar/stellar-backend-ai-lcov.info
          flags: stellar-backend-ai
          fail_ci_if_error: true

  build:
    name: build (${{ matrix.package }}, ${{ matrix.variant }})
    timeout-minutes: 90
    strategy:
      matrix:
        package:
          - solidity
          - cairo
          - stellar
          - stylus
        # This variant config creates 2 branches of the matrix a default and a compile one to run the compile tests in their own job
        variant:
          - default
          - compile
        exclude:
          - package: solidity
            variant: compile
          - package: cairo
            variant: compile
          - package: stylus
            variant: compile

    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          fetch-depth: 0
      - name: Set up environment
        uses: ./.github/actions/setup

      # ----------------------------
      # Solidity setup
      - name: Install Foundry
        if: matrix.package == 'solidity'
        uses: foundry-rs/foundry-toolchain@82dee4ba654bd2146511f85f0d013af94670c4de #v1.4.0

      # ----------------------------
      # Stellar compile setup

      - name: Cache Rust dependencies
        if: matrix.package == 'stellar' && matrix.variant == 'compile'
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: |
            ~/.cargo/bin/
            runner/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: cargo-${{ matrix.package }}

      - name: Set up rust toolchain
        if: matrix.package == 'stellar' && matrix.variant == 'compile'
        uses: actions-rust-lang/setup-rust-toolchain@1780873c7b576612439a134613cc4cc74ce5538c # v1.15.2
        with:
          toolchain: stable, nightly
          components: clippy, rustfmt, llvm-tools-preview
          target: wasm32v1-none

      # ----------------------------
      - name: Compile TypeScript
        run: yarn tsc
        working-directory: packages/core/${{matrix.package}}
      - name: Check Svelte
        run: yarn svelte-check
        working-directory: packages/ui
      - name: Run tests
        if: matrix.variant == 'default'
        run: yarn test '**/*.test.ts' '**/test.ts' '!**/*.compile.test.ts'
        working-directory: packages/core/${{matrix.package}}

      - name: Get list of changed files
        id: filter
        if: matrix.variant == 'compile'
        run: |
          BASE=${{ github.event.pull_request.base.sha || github.event.before }}
          echo "changes=$(git diff --name-only $BASE ${{ github.sha }} | tr '\n' ' ')" >> $GITHUB_OUTPUT

      - name: Run tests
        if: matrix.variant == 'compile' && contains(steps.filter.outputs.changes, format('packages/core/{0}/', matrix.package))
        env:
          RUSTFLAGS: ""
        run: |
          FILES=$(find ./ -type f -name '*.compile.test.ts')
          if [ -z "$FILES" ]; then
            echo "No compile tests found. Skipping."
            exit 0
          else
            yarn test '**/*.compile.test.ts'
          fi
        working-directory: packages/core/${{matrix.package}}
