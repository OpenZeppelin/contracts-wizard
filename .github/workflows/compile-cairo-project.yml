name: Validate Cairo Test Project

on:
  pull_request:
  push:

jobs:
  validate-cairo:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        kind:
          - ERC20
          - ERC721
          - ERC1155
          - Account
          - Governor
          - Vesting
          - Custom
      max-parallel: 1

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup node
        uses: actions/setup-node@v4
        with:
          node-version: 18.x
          cache: 'yarn'
          
      - name: Install dependencies
        working-directory: packages/core/cairo
        run: yarn install --network-concurrency 1

      - name: Extract Scarb version
        working-directory: packages/core/cairo/test_project
        run: |
          SCARB_VERSION=$(grep 'scarb-version = ' Scarb.toml | sed 's/scarb-version = "\(.*\)"/\1/')
          echo "SCARB_VERSION=$SCARB_VERSION" >> "$GITHUB_ENV"
      
      - name: Setup Scarb
        uses: software-mansion/setup-scarb@v1
        with:
          scarb-version: ${{ env.SCARB_VERSION }}

      - name: Generate Test Project
        working-directory: packages/core/cairo
        run: yarn run update_scarb_project ${{ matrix.kind }}

      - name: Compile Test Project
        working-directory: packages/core/cairo/test_project
        run: scarb build
      
