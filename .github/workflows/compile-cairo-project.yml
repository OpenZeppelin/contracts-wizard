name: Validate Cairo Test Project

on:
  pull_request:
    paths:
      - 'packages/core/cairo/**'
  push:

jobs:
  validate-cairo:
    runs-on: ubuntu-latest
    concurrency:
      group: validate-cairo-${{ github.ref }}
      cancel-in-progress: true

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup node
        uses: actions/setup-node@v4
        with:
          node-version: 18.x
          cache: 'yarn'
          
      - name: Install dependencies
        working-directory: packages/core/cairo
        run: yarn install --network-concurrency 1

      - name: Extract Scarb version
        working-directory: packages/core/cairo/test_project
        run: |
          SCARB_VERSION=$(grep 'scarb-version = ' Scarb.toml | sed 's/scarb-version = "\(.*\)"/\1/')
          echo "SCARB_VERSION=$SCARB_VERSION" >> "$GITHUB_ENV"
      
      - name: Setup Scarb
        uses: software-mansion/setup-scarb@v1
        with:
          scarb-version: ${{ env.SCARB_VERSION }}

      - name: Generate and compile test project
        working-directory: packages/core/cairo/test_project
        run: |
          # Exit immediately if a command exits with a non-zero status
          set -e 

          declare -a all_kinds=("ERC1155")
          for kind in "${all_kinds[@]}"; do
            scarb clean

            echo "Generating '$kind' test project..."
            yarn run update_scarb_project $kind

            echo "Compiling '$kind' test project..."
            scarb build

            echo "âœ… Compiled '$kind' test project!"
            echo "---------------------------------"
          done
