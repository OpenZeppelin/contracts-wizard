name: Compile Cairo test project

on:
  pull_request:
  push:

jobs:
  setup:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 18.x
          cache: 'yarn'
      - name: Install dependencies
        working-directory: packages/core/cairo
        run: yarn install --network-concurrency 1

      - name: Extract Scarb version
        working-directory: packages/core/cairo/test_project
        run: |
          SCARB_VERSION=$(grep 'scarb-version = ' Scarb.toml | sed 's/scarb-version = "\(.*\)"/\1/')
          echo "SCARB_VERSION=$SCARB_VERSION" >> "$GITHUB_ENV"

      - uses: software-mansion/setup-scarb@v1
        with:
          scarb-version: ${{ env.SCARB_VERSION }}

  validate:
    strategy:
      matrix:
        kind:
          - ERC20
          - ERC721
          - ERC1155
          - Account
          - Governor
          - Vesting
          - Custom

    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Generate Test Project
        working-directory: packages/core/cairo
        run: |
          # Install dependencies if required
          yarn install
          # Generate test project
          yarn run update_scarb_project ${{matrix.kind}}

      - name: Compile test project
        run: scarb build
